(ns vis-1.utils
  (:require
    [rum.core :as rum]
    [vis-1.state :refer [node-state app-state]]
    [cemerick.url :refer [url url-encode]]
    [cljs.pprint :as pprint]
    [rum.core :as rum :refer [defc defcs]]
    [taoensso.timbre :as timbre
     :refer-macros [log trace debug info warn error fatal report
                    logf tracef debugf infof warnf errorf fatalf reportf
                    spy get-env]]
    [clojure.string :as str]
    [cljs-react-material-ui.rum :as ui]))


(defn node-count []
  (let [node-dataset (:nodes @node-state)
        node-count (count node-dataset)]
    (info "Node Count: " node-count)
    node-count))

(defn get-compute [coll]
  (filter #(= (:type %) "compute")
          (mapv (fn [node]
                  (select-keys node [:id :name :type])) coll)))

(defn json->clj [string]
  (try
    (print string)
    (js->clj (.parse js/JSON string) :keywordize-keys true)
    (catch js/SyntaxError err
      (print "Error: Error parsing object " err))))


(defn add-node-dataset [& v]
  (info "add-node-dataset")
  (let [[id label title link parent] v
        node {:id id :text label :label label :title title :link link}
        edge {:from parent :to id}]
    (if (not-any? #{id} (map :id (:nodes @node-state)))
      (do
        (swap! node-state update-in [:nodes] conj node)
        (when (not (nil? parent))
          (swap! node-state update-in [:edges] conj edge))))))




(defn update-service-root [m]
  (info "update-service-root")
  (let [edge-state (rum/cursor node-state :edges)
        node-state (rum/cursor node-state :nodes)]
    (reduce (fn [a coll]
              (let [name (get coll "name")
                    link (get coll "url")]
                (swap! node-state conj {:id name :label name :link link})
                (swap! edge-state conj {:from name :to "ServiceRoot"})))
            []
            m)))

(defn update-network [n o]
  (info "update-network")
  (let [network (get @app-state :network)]
    (.setOptions network (clj->js o))
    (.setData network (clj->js n))))


(defn get-nodes
  []
  (:nodes @node-state))

(defn add-nodes [m root]
  (info "add-nodes")
  (map (fn [r]
         (let [name (key r)
               link (get (val r) "@odata.id")]
           (info "adding node " name)
           (add-node-dataset name name name link)))
       m))

(defc status [s]
  [:svg {:height "100%" :width "100%"}
   [:circle {:cx "10" :cy "10" :r "7" :stroke "black" :fill "green"}]])

(defc jet-icon []
  (ui/svg-icon
    {:hover-color "yellow"
     :color       "white"
     :viewBox     "0 0 511.994 511.994"}
    ;:style   {:enable-background:new "0 0 511.994 511.994"}}
    [:path {:d "M510.868,362.698l-34.133-59.733c-1.519-2.662-4.343-4.301-7.407-4.301h-5.751l13.961-48.853    c1.126-3.951-0.717-8.141-4.386-9.975l-7.629-3.814l27.537-34.423c1.749-2.176,2.313-5.069,1.519-7.748    c-0.794-2.68-2.842-4.796-5.487-5.683l-20.745-6.912l8.994-24.738c1.476-4.079-0.333-8.61-4.207-10.547l-17.067-8.533c-3.123-1.562-6.878-1.067-9.489,1.254l-58.308,51.831l12.638-69.53c0.452-2.492-0.222-5.052-1.843-6.989c-1.621-1.937-4.011-3.072-6.537-3.072h-25.6c-2.039,0-4.011,0.725-5.555,2.057L243.604,213.936l-37.7,7.535    c-3.447-2.56-8.38-4.872-15.625-6.502c-10.812-2.441-24.755-2.978-39.253-1.51c-14.498,1.459-28.049,4.762-38.161,9.301    c-13.099,5.88-17.502,12.536-18.492,18.039l-88.09,24.03c-3.994,1.092-6.63,4.89-6.246,9.011c0.375,4.122,3.661,7.381,7.791,7.723    l101.623,8.431l142.805,25.199l99.046,83.328c0.819,0.7,1.775,1.229,2.79,1.57l1.604,0.538c0.87,0.29,1.783,0.435,2.697,0.435    c0.7,0,1.391-0.085,2.074-0.256l34.133-8.533c4.574-1.143,7.347-5.777,6.212-10.351l-14.976-59.904l12.279,1.886l83.9,50.338    c1.289,0.777,2.756,1.195,4.258,1.22l17.067,0.265c0.034,0,0.077,0,0.119,0c2.244,0,4.403-1.007,6.007-2.586    c1.604-1.604,2.526-3.925,2.526-6.212C511.994,365.446,511.602,363.987,510.868,362.698z M472.084,200.488l-19.669,24.585    l10.104-27.776L472.084,200.488z M370.085,127.997h12.22l-14.165,77.901l-44.587,7.432h-53.026L370.085,127.997z M152.741,230.44    c23.441-2.389,38.229,1.553,42.539,4.292c-3.669,3.541-17.365,10.317-40.832,12.681c-23.467,2.355-38.238-1.553-42.539-4.292    C115.578,239.588,129.274,232.804,152.741,230.44z M359.802,383.374l-98.321-82.714c-1.143-0.964-2.526-1.613-4.011-1.877    l-145.843-25.702l-54.221-4.514l44.075-12.023c3.439,2.492,8.328,4.736,15.411,6.332c6.827,1.536,14.899,2.313,23.569,2.313    c5.069,0,10.334-0.265,15.684-0.802c14.498-1.459,28.049-4.762,38.161-9.301c12.732-5.717,17.271-12.177,18.424-17.587l35.575-7.1    h75.955c0.469,0,0.939-0.034,1.408-0.119l51.174-8.533c0.102-0.017,0.196-0.034,0.299-0.051h0.009    c1.579-0.316,2.97-1.058,4.079-2.074l72.38-64.341l5.103,2.551l-31.539,86.716c-0.247,0.674-0.239,1.357-0.307,2.039    l-37.692,26.923L288.72,290.25c-4.13,0.691-7.151,4.275-7.125,8.474c0.026,4.198,3.089,7.74,7.236,8.38l78.703,12.109    l14.643,58.573L359.802,383.374z M405.447,308.417c-0.947-0.572-1.997-0.947-3.098-1.118l-58.291-8.977l49.877-8.311    c1.28-0.213,2.492-0.717,3.558-1.468l55.552-39.68l6.135,3.072l-15.121,52.924c-0.734,2.577-0.222,5.342,1.391,7.484    c1.613,2.142,4.13,3.388,6.81,3.388h12.117l24.38,42.667L405.447,308.417z"}]))

(defc jet []
  [:svg {:height  "50"
         :width   "50"
         :id      "Layer_1"
         :x       "0px"
         :y       "0px"
         :viewBox "0 0 511.994 511.994"
         :style   {:enable-background:new "0 0 511.994 511.994"}}
   ;[:xml {:space "preserve" :width "512px" :height "512px"}]}
   [:g
    [:path {:d    "M510.868,362.698l-34.133-59.733c-1.519-2.662-4.343-4.301-7.407-4.301h-5.751l13.961-48.853    c1.126-3.951-0.717-8.141-4.386-9.975l-7.629-3.814l27.537-34.423c1.749-2.176,2.313-5.069,1.519-7.748    c-0.794-2.68-2.842-4.796-5.487-5.683l-20.745-6.912l8.994-24.738c1.476-4.079-0.333-8.61-4.207-10.547l-17.067-8.533c-3.123-1.562-6.878-1.067-9.489,1.254l-58.308,51.831l12.638-69.53c0.452-2.492-0.222-5.052-1.843-6.989c-1.621-1.937-4.011-3.072-6.537-3.072h-25.6c-2.039,0-4.011,0.725-5.555,2.057L243.604,213.936l-37.7,7.535    c-3.447-2.56-8.38-4.872-15.625-6.502c-10.812-2.441-24.755-2.978-39.253-1.51c-14.498,1.459-28.049,4.762-38.161,9.301    c-13.099,5.88-17.502,12.536-18.492,18.039l-88.09,24.03c-3.994,1.092-6.63,4.89-6.246,9.011c0.375,4.122,3.661,7.381,7.791,7.723    l101.623,8.431l142.805,25.199l99.046,83.328c0.819,0.7,1.775,1.229,2.79,1.57l1.604,0.538c0.87,0.29,1.783,0.435,2.697,0.435    c0.7,0,1.391-0.085,2.074-0.256l34.133-8.533c4.574-1.143,7.347-5.777,6.212-10.351l-14.976-59.904l12.279,1.886l83.9,50.338    c1.289,0.777,2.756,1.195,4.258,1.22l17.067,0.265c0.034,0,0.077,0,0.119,0c2.244,0,4.403-1.007,6.007-2.586    c1.604-1.604,2.526-3.925,2.526-6.212C511.994,365.446,511.602,363.987,510.868,362.698z M472.084,200.488l-19.669,24.585    l10.104-27.776L472.084,200.488z M370.085,127.997h12.22l-14.165,77.901l-44.587,7.432h-53.026L370.085,127.997z M152.741,230.44    c23.441-2.389,38.229,1.553,42.539,4.292c-3.669,3.541-17.365,10.317-40.832,12.681c-23.467,2.355-38.238-1.553-42.539-4.292    C115.578,239.588,129.274,232.804,152.741,230.44z M359.802,383.374l-98.321-82.714c-1.143-0.964-2.526-1.613-4.011-1.877    l-145.843-25.702l-54.221-4.514l44.075-12.023c3.439,2.492,8.328,4.736,15.411,6.332c6.827,1.536,14.899,2.313,23.569,2.313    c5.069,0,10.334-0.265,15.684-0.802c14.498-1.459,28.049-4.762,38.161-9.301c12.732-5.717,17.271-12.177,18.424-17.587l35.575-7.1    h75.955c0.469,0,0.939-0.034,1.408-0.119l51.174-8.533c0.102-0.017,0.196-0.034,0.299-0.051h0.009    c1.579-0.316,2.97-1.058,4.079-2.074l72.38-64.341l5.103,2.551l-31.539,86.716c-0.247,0.674-0.239,1.357-0.307,2.039    l-37.692,26.923L288.72,290.25c-4.13,0.691-7.151,4.275-7.125,8.474c0.026,4.198,3.089,7.74,7.236,8.38l78.703,12.109    l14.643,58.573L359.802,383.374z M405.447,308.417c-0.947-0.572-1.997-0.947-3.098-1.118l-58.291-8.977l49.877-8.311    c1.28-0.213,2.492-0.717,3.558-1.468l55.552-39.68l6.135,3.072l-15.121,52.924c-0.734,2.577-0.222,5.342,1.391,7.484    c1.613,2.142,4.13,3.388,6.81,3.388h12.117l24.38,42.667L405.447,308.417z"
            :fill "#FFFFFF"}]]])

(rum/defc footer-template < rum/reactive [app-state]
  [:footer.page-footer
   [:div.row
    [:div.footer-copyright.col.l2 [:p "Â© 2017 DELL-EMC"]]
    [:div.col.l6.right {:style {:text-align "right"}}
     "version 0.0.1"]]])
